---
- name: DelphinusLab Dockeré•œåƒæ„å»ºå¹¶æ¨é€åˆ°Docker Hub
  hosts: all
  become: yes
  vars:
    # æ„å»ºç›¸å…³é…ç½®
    build_dir: "/opt/prover-node-docker"
    # Docker Hubé…ç½® - é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ å…¥
    docker_username: "{{ docker_username | default('') }}"
    docker_password: "{{ docker_password | default('') }}"
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    # ç¡®ä¿åŸºç¡€ç¯å¢ƒ
    - name: æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…
      apt:
        update_cache: yes
        upgrade: yes
        cache_valid_time: 3600
      tags: update

    - name: å®‰è£…æ„å»ºä¾èµ–
      apt:
        name:
          - git
          - curl
          - wget
          - build-essential
        state: present
      tags: dependencies

    # å®‰è£…Docker (å¦‚æœæ„å»ºæœºå™¨ä¸Šæ²¡æœ‰)
    - name: æ£€æŸ¥Dockeræ˜¯å¦å·²å®‰è£…
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false
      tags: docker

    - name: å®‰è£…Docker (å¦‚æœæœªå®‰è£…)
      block:
        - name: ç§»é™¤æ—§ç‰ˆæœ¬DockeråŒ…
          apt:
            name:
              - docker.io
              - docker-doc
              - docker-compose
              - podman-docker
              - containerd
              - runc
            state: absent

        - name: å®‰è£…ä¾èµ–åŒ…
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
            state: present

        - name: åˆ›å»ºDocker GPGå¯†é’¥ç›®å½•
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: æ·»åŠ Docker GPGå¯†é’¥
          shell: |
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg

        - name: æ·»åŠ Dockerä»“åº“
          shell: |
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          args:
            creates: /etc/apt/sources.list.d/docker.list

        - name: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜
          apt:
            update_cache: yes

        - name: å®‰è£…Dockerç»„ä»¶
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present

        - name: å¯åŠ¨DockeræœåŠ¡
          systemd:
            name: docker
            enabled: yes
            state: started
      when: docker_check.rc != 0
      tags: docker

    # æ„å»ºç›¸å…³ä»»åŠ¡
    - name: å…‹éš†prover-node-dockerä»“åº“
      git:
        repo: https://github.com/DelphinusLab/prover-node-docker
        dest: "{{ build_dir }}"
        force: yes
      tags: clone

    - name: æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨
      stat:
        path: "{{ build_dir }}/scripts/build_image.sh"
      register: build_script
      tags: build

    - name: æ„å»ºDockeré•œåƒ
      command: bash scripts/build_image.sh
      args:
        chdir: "{{ build_dir }}"
      when: build_script.stat.exists
      tags: build

    - name: è·å–æ„å»ºçš„é•œåƒä¿¡æ¯
      shell: docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" | head -5
      register: built_images
      tags: build

    # æ¨é€åˆ°Docker Hub
    - name: ç™»å½•Docker Hub
      docker_login:
        username: "{{ docker_username }}"
        password: "{{ docker_password }}"
      when: 
        - docker_username != ''
        - docker_password != ''
      tags: push

    - name: æ ‡è®°å¹¶æ¨é€é•œåƒåˆ°Docker Hub
      shell: |
        # è·å–æœ¬åœ°æ„å»ºçš„é•œåƒåç§°å¹¶æ¨é€åˆ°Docker Hub
        docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "(prover|delphinus)" | while IFS= read -r local_image; do
          # æå–é•œåƒåç§°ï¼ˆå»æ‰tagéƒ¨åˆ†ï¼‰
          image_name=$(echo "$local_image" | cut -d':' -f1)
          # åˆ›å»ºDocker Hubæ ‡ç­¾
          hub_tag="{{ docker_username }}/${image_name}:{{ image_tag }}"
          echo "æ ‡è®°é•œåƒ: $local_image -> $hub_tag"
          docker tag "$local_image" "$hub_tag"
          echo "æ¨é€é•œåƒ: $hub_tag"
          docker push "$hub_tag"
        done
      when: 
        - docker_username != ''
        - docker_password != ''
      register: push_result
      tags: push

  post_tasks:
    - name: æ˜¾ç¤ºæ„å»ºå®Œæˆä¿¡æ¯
      debug:
        msg: |
          ================================
          Dockeré•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆï¼
          ================================
          
          ğŸ“¦ æ„å»ºçš„é•œåƒï¼š
          {{ built_images.stdout }}
          
          {% if docker_username != '' %}
          ğŸš€ æ¨é€ç»“æœï¼š
          {{ push_result.stdout if push_result is defined else 'æœªæ‰§è¡Œæ¨é€' }}
          
          ğŸ’¡ éƒ¨ç½²å‘½ä»¤ï¼š
          ansible-playbook -i inventory.ini delphinus-setup.yml \
            -e "private_key=ä½ çš„ç§é’¥" \
            -e "image_tag={{ image_tag }}" \
            -e "docker_username={{ docker_username }}"
          {% else %}
          âš ï¸  æœªé…ç½®Docker Hubå‡­æ®ï¼Œé•œåƒæœªæ¨é€
          è¯·è®¾ç½®: -e "docker_username=ç”¨æˆ·å" -e "docker_password=å¯†ç "
          {% endif %} 