# DelphinusLab Ansible Playbook 使用说明

## 文件说明

- `delphinus-setup.yml` - 主要的Ansible playbook文件
- `inventory.ini` - 主机清单文件
- `使用说明.md` - 本说明文档

## 前置要求

1. **控制机器** (运行Ansible的机器):
   - 已安装 Ansible (建议版本 >= 2.9)
   - 可以通过SSH连接到目标服务器

2. **目标服务器**:
   - Ubuntu 操作系统
   - 显卡: RTX 4090以上 (如果需要CUDA)
   - 内存: >82 GB
   - SSH 访问权限和 sudo 权限
   - **注意**: NVIDIA驱动可选 - 如果使用Vast.ai等预配置的云服务器，可能已经安装

## 安装步骤

### 1. 配置 Inventory 文件

编辑 `inventory.ini` 文件，添加你的服务器信息：

```ini
[delphinus_servers]
192.168.1.100 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa
# 或者
your-server.com ansible_user=ubuntu
```

### 2. 测试连接

```bash
ansible -i inventory.ini delphinus_servers -m ping
```

### 3. 运行安装

#### 基础安装 (推荐 - 适用于Vast.ai等预配置环境)

```bash
# 仅安装基础组件，跳过CUDA (适用于已有CUDA环境)
ansible-playbook -i inventory.ini delphinus-setup.yml -e "private_key=你的EVM私钥"
```

#### 完整安装 (包含CUDA)

```bash
# 完整安装，包括CUDA toolkit
ansible-playbook -i inventory.ini delphinus-setup.yml -e "private_key=你的EVM私钥" -e "install_cuda=true"
```

**重要说明:**
- `private_key`: 你的EVM钱包私钥 (去掉0x前缀)
- `install_cuda=true`: 可选参数，仅在需要安装CUDA时添加

### 4. 分步执行 (可选)

你也可以使用 tags 分步执行：

```bash
# 只更新系统和安装基础包
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "environment,update,packages"

# 只安装 Docker
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "docker"

# 强制安装 CUDA (仅在需要时)
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "cuda" -e "install_cuda=true"

# 设置 HugePages
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "hugepages"

# 配置和启动 Prover
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "prover,build,start" -e "private_key=你的私钥"
```

## 新功能特性

### 🔐 自动私钥配置
- 不再需要手动编辑配置文件
- 通过命令行参数 `-e "private_key=你的私钥"` 直接传入
- 支持动态配置，更安全便捷

### ⚡ 智能CUDA检测
- **默认跳过CUDA安装** - 适用于Vast.ai等预配置环境
- 仅在明确需要时安装: `-e "install_cuda=true"`
- 节省时间，避免不必要的重复安装

## 安装后配置

### 自动完成的步骤：
1. ✅ **私钥自动配置** - 如果正确传入了private_key参数
2. ✅ **所有系统配置** - 环境变量、软件包、Docker等
3. ✅ **HugePages设置** - 内存优化配置
4. ✅ **Prover节点自动启动**

### 需要验证的步骤：

1. **验证安装**:
   ```bash
   # 检查NVIDIA驱动 (如果已有)
   nvidia-smi
   
   # 检查CUDA (如果安装了)
   nvcc --version
   
   # 检查HugePages
   grep Huge /proc/meminfo
   
   # 检查Docker
   docker ps
   ```

2. **重启系统** (仅在安装了CUDA时推荐):
   如果使用了 `install_cuda=true`，建议重启系统使所有组件完全生效。

## 使用场景

### 场景一: Vast.ai 或其他云GPU服务器 (推荐)
```bash
# 基础安装，跳过CUDA
ansible-playbook -i inventory.ini delphinus-setup.yml -e "private_key=你的私钥"
```

### 场景二: 全新的Ubuntu服务器
```bash
# 完整安装，包含CUDA
ansible-playbook -i inventory.ini delphinus-setup.yml -e "private_key=你的私钥" -e "install_cuda=true"
```

### 场景三: 仅更新配置或重新部署
```bash
# 仅重新配置和启动
ansible-playbook -i inventory.ini delphinus-setup.yml --tags "prover,build,start" -e "private_key=新的私钥"
```

## 管理命令

```bash
# 查看日志
cd /opt/prover-node-docker && docker compose logs -fn 100

# 停止节点
cd /opt/prover-node-docker && docker compose down -v

# 重启节点
cd /opt/prover-node-docker && docker compose up -d

# 查看所有容器
docker ps -a
```

## 监控节点状态

访问 https://explorer.zkwasmhub.com/nodes 输入你的钱包地址查看节点状态。

## 故障排除

1. **内存不足**: 确保系统有足够的物理内存 (>82GB)
2. **GPU问题**: 运行 `nvidia-smi` 检查GPU状态
3. **私钥错误**: 确保私钥格式正确 (去掉0x前缀)
4. **Docker权限**: 确保当前用户在docker组中
5. **网络问题**: 检查防火墙和网络连接

## 安全提醒

- 私钥通过命令行参数传入时，注意命令历史记录的安全性
- 建议使用专用的EVM钱包，避免使用主钱包
- 定期备份重要配置和钱包

## 注意事项

- playbook运行可能需要较长时间，特别是构建Docker镜像的步骤
- 仅在安装CUDA时需要考虑重启系统
- 适合Vast.ai等预配置环境，大大节省部署时间
- 建议在非生产环境先测试 