---
- name: DelphinusLab éƒ¨ç½²é…ç½® (ä»Docker Hubæ‹‰å–é•œåƒ)
  hosts: all
  become: yes
  vars:
    hugepages_count: 15000
    server_url: "https://rpc.zkwasmhub.com:8090"
    # ç§é’¥å˜é‡ - é€šè¿‡å‘½ä»¤è¡Œå‚æ•° -e "private_key=your_key" ä¼ å…¥
    private_key: "{{ private_key | default('YOUR_PRIVATE_KEY_HERE') }}"
    # CUDAå®‰è£…å¼€å…³ - é»˜è®¤ä¸ºfalseï¼Œé€šè¿‡ -e "install_cuda=true" å¯ç”¨
    install_cuda: "{{ install_cuda | default(false) }}"
    # Docker Hubé•œåƒé…ç½®
    docker_username: "{{ docker_username | default('') }}"
    image_tag: "{{ image_tag | default('latest') }}"
    deploy_dir: "/opt/prover-node-docker"
  
  tasks:
    # ç¬¬ä¸€æ­¥: é…ç½®ç¯å¢ƒå˜é‡
    - name: é…ç½® /etc/environment æ–‡ä»¶
      copy:
        content: |
          PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        dest: /etc/environment
        backup: yes
      tags: environment

    # ç¬¬äºŒæ­¥: æ›´æ–°ç³»ç»Ÿå’Œå®‰è£…åŸºç¡€è½¯ä»¶åŒ…
    - name: æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…
      apt:
        update_cache: yes
        upgrade: yes
        cache_valid_time: 3600
      tags: update

    - name: å®‰è£…åŸºç¡€è½¯ä»¶åŒ…
      apt:
        name:
          - curl
          - iptables
          - build-essential
          - git
          - wget
          - lz4
          - jq
          - make
          - gcc
          - nano
          - automake
          - autoconf
          - tmux
          - htop
          - nvme-cli
          - libgbm1
          - pkg-config
          - libssl-dev
          - libleveldb-dev
          - tar
          - clang
          - bsdmainutils
          - ncdu
          - unzip
          - ca-certificates
          - gnupg
        state: present
      tags: packages

    # ç¬¬ä¸‰æ­¥: å®‰è£… Docker
    - name: ç§»é™¤æ—§ç‰ˆæœ¬ Docker åŒ…
      apt:
        name:
          - docker.io
          - docker-doc
          - docker-compose
          - podman-docker
          - containerd
          - runc
        state: absent
      tags: docker

    - name: åˆ›å»º Docker GPG å¯†é’¥ç›®å½•
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: docker

    - name: æ·»åŠ  Docker GPG å¯†é’¥
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      tags: docker

    - name: æ·»åŠ  Docker ä»“åº“
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list
      tags: docker

    - name: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜ (Dockerä»“åº“)
      apt:
        update_cache: yes
      tags: docker

    - name: å®‰è£… Docker ç»„ä»¶
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      tags: docker

    # ç¬¬å››æ­¥: å®‰è£… NVIDIA CUDA (å¯é€‰ï¼Œé»˜è®¤è·³è¿‡)
    - name: è·å–ç³»ç»Ÿåˆ†å‘ç‰ˆæœ¬ä¿¡æ¯
      shell: . /etc/os-release && echo $ID$VERSION_ID
      register: distribution
      changed_when: false
      when: install_cuda | bool
      tags: cuda

    - name: æ·»åŠ  NVIDIA Container Toolkit GPG å¯†é’¥
      shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      when: install_cuda | bool
      tags: cuda

    - name: æ·»åŠ  NVIDIA Container Toolkit ä»“åº“
      shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/{{ distribution.stdout }}/libnvidia-container.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#' | \
        tee /etc/apt/sources.list.d/nvidia-container-toolkit.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      when: install_cuda | bool
      tags: cuda

    - name: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜ (NVIDIAä»“åº“)
      apt:
        update_cache: yes
      when: install_cuda | bool
      tags: cuda

    - name: å®‰è£… NVIDIA CUDA toolkit
      apt:
        name: nvidia-cuda-toolkit
        state: present
      when: install_cuda | bool
      tags: cuda

    - name: å®‰è£… NVIDIA Container Toolkit
      apt:
        name: nvidia-container-toolkit
        state: present
      when: install_cuda | bool
      tags: cuda

    - name: é…ç½® NVIDIA Container Runtime
      shell: nvidia-ctk runtime configure --runtime=docker --set-as-default
      when: install_cuda | bool
      tags: cuda

    - name: å¸è½½ NVIDIA å†…æ ¸æ¨¡å— (ä¸ºé‡å¯åšå‡†å¤‡)
      shell: rmmod nvidia_drm nvidia_modeset nvidia_uvm nvidia || true
      ignore_errors: yes
      when: install_cuda | bool
      tags: cuda

    - name: å¯ç”¨å¹¶é‡å¯ Docker æœåŠ¡
      systemd:
        name: docker
        enabled: yes
        state: restarted
      tags: docker

    # ç¬¬äº”æ­¥: è®¾ç½® HugePages
    - name: ä¸´æ—¶è®¾ç½® HugePages
      sysctl:
        name: vm.nr_hugepages
        value: "{{ hugepages_count }}"
        state: present
      tags: hugepages

    - name: æ°¸ä¹…è®¾ç½® HugePages
      lineinfile:
        path: /etc/sysctl.conf
        line: "vm.nr_hugepages={{ hugepages_count }}"
        regexp: '^vm\.nr_hugepages='
        state: present
      tags: hugepages

    - name: åº”ç”¨ sysctl é…ç½®
      command: sysctl -p
      tags: hugepages

    # ç¬¬å…­æ­¥: å‡†å¤‡éƒ¨ç½²ç¯å¢ƒå’Œé…ç½®
    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: '0755'
      tags: deploy

    - name: å…‹éš†prover-node-dockerä»“åº“ (è·å–é…ç½®æ–‡ä»¶å’Œè„šæœ¬)
      git:
        repo: https://github.com/DelphinusLab/prover-node-docker
        dest: "{{ deploy_dir }}"
        force: yes
      tags: deploy

    # ä»Docker Hubæ‹‰å–é•œåƒ
    - name: ä»Docker Hubæ‹‰å–Dockeré•œåƒ
      shell: |
        if [ "{{ docker_username }}" != "" ]; then
          echo "ä»Docker Hubæ‹‰å–é•œåƒ: {{ docker_username }}/prover-node:{{ image_tag }}"
          docker pull {{ docker_username }}/prover-node:{{ image_tag }} || echo "é•œåƒæ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é•œåƒåç§°å’Œæ ‡ç­¾"
        else
          echo "é”™è¯¯: æœªæŒ‡å®šdocker_usernameï¼Œæ— æ³•æ‹‰å–é•œåƒ"
          exit 1
        fi
      register: pull_result
      tags: pull

    - name: åˆ›å»º prover_config.json é…ç½®æ–‡ä»¶
      copy:
        content: |
          {
            "server_url": "{{ server_url }}",
            "priv_key": "{{ private_key }}"
          }
        dest: "{{ deploy_dir }}/prover_config.json"
      tags: deploy

    - name: åˆ›å»º dry_run_config.json é…ç½®æ–‡ä»¶
      copy:
        content: |
          {
            "server_url": "{{ server_url }}",
            "priv_key": "{{ private_key }}"
          }
        dest: "{{ deploy_dir }}/dry_run_config.json"
      tags: deploy

    - name: ä¿®æ”¹å¯åŠ¨è„šæœ¬ (æ·»åŠ  -d å‚æ•°)
      lineinfile:
        path: "{{ deploy_dir }}/scripts/start.sh"
        regexp: '^docker compose up$'
        line: 'docker compose up -d'
        backup: yes
      tags: deploy

    # è¿è¡ŒèŠ‚ç‚¹
    - name: å¯åŠ¨ Prover èŠ‚ç‚¹ (ä½¿ç”¨Docker Hubé•œåƒ)
      command: bash scripts/start.sh
      args:
        chdir: "{{ deploy_dir }}"
      tags: start

  # åç½®æé†’ä»»åŠ¡
  post_tasks:
    - name: æ˜¾ç¤ºCUDAè·³è¿‡æé†’
      debug:
        msg: |
          âš ï¸  CUDAå®‰è£…å·²è·³è¿‡ï¼
          å¦‚æœéœ€è¦å®‰è£…CUDAï¼Œè¯·è¿è¡Œï¼š
          ansible-playbook -i inventory.ini delphinus-setup.yml -e "install_cuda=true"
      when: not (install_cuda | bool)

    - name: æ˜¾ç¤ºç§é’¥é…ç½®çŠ¶æ€
      debug:
        msg: |
          {% if private_key == 'YOUR_PRIVATE_KEY_HERE' %}
          âš ï¸  ç§é’¥æœªè®¾ç½®ï¼
          è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡æ–°è¿è¡Œå¹¶è®¾ç½®ç§é’¥ï¼š
          ansible-playbook -i inventory.ini delphinus-setup.yml -e "private_key=ä½ çš„ç§é’¥"
          {% else %}
          âœ… ç§é’¥å·²è‡ªåŠ¨é…ç½®å®Œæˆ
          {% endif %}

    - name: æ˜¾ç¤ºé•œåƒæ‹‰å–ç»“æœ
      debug:
        msg: |
          ğŸ“¦ é•œåƒæ‹‰å–ç»“æœï¼š
          {{ pull_result.stdout }}

    - name: æ˜¾ç¤ºéƒ¨ç½²å®Œæˆä¿¡æ¯å’Œæ³¨æ„äº‹é¡¹
      debug:
        msg: |
          ================================
          DelphinusLab éƒ¨ç½²å®Œæˆï¼
          ================================
          
          {% if install_cuda | bool %}
          âš ï¸  é‡è¦æé†’ï¼š
          æŸäº›æ­¥éª¤å¯èƒ½éœ€è¦é‡å¯ç³»ç»Ÿæ‰èƒ½å®Œå…¨ç”Ÿæ•ˆï¼Œç‰¹åˆ«æ˜¯NVIDIAé©±åŠ¨å’Œå†…æ ¸æ¨¡å—ã€‚
          {% endif %}
          
          ğŸ³ ä½¿ç”¨çš„é•œåƒï¼š
          {% if docker_username != '' %}
          {{ docker_username }}/prover-node:{{ image_tag }}
          {% else %}
          æœªæŒ‡å®šé•œåƒä¿¡æ¯
          {% endif %}
          
          ğŸ”§ éªŒè¯å®‰è£…ï¼š
          - NVIDIAé©±åŠ¨: nvidia-smi
          - CUDA toolkit: nvcc --version
          - HugePages: grep Huge /proc/meminfo
          
          ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š
          - æŸ¥çœ‹æ—¥å¿—: cd {{ deploy_dir }} && docker compose logs -fn 100
          - åœæ­¢èŠ‚ç‚¹: cd {{ deploy_dir }} && docker compose down -v
          - é‡å¯èŠ‚ç‚¹: cd {{ deploy_dir }} && docker compose up -d
          
          ğŸŒ æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼š
          è®¿é—® https://explorer.zkwasmhub.com/nodes è¾“å…¥ä½ çš„é’±åŒ…åœ°å€ 